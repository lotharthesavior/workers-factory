<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body onload="start()">

<div><a href="#" onclick="add_product()">Add Product</a></div>
<div><a href="#" onclick="add_worker(0.5)">Add Worker</a></div>

<div id="container">
  <div id="products">Products: <span class="count">0</span></div>
  <div id="workers">Workers: <span class="count">0</span></div>
</div>

<script>

// BEGIN: constants

const MAIN_MODEL_KEY = 'main_model';

// END: constants

// BEGIN: bases

var base_main_model = {
  products: 0,
  clicked_products: 0,
  workers: []
};

var base_worker_model = {
  created_at: 0
};

// END: bases

// BEGIN: variables

var main_model;

// END: variables

function start() {
  var stored_main_model = localStorage.getItem(MAIN_MODEL_KEY);
  if (stored_main_model === null) {
    main_model = Object.assign({}, base_main_model);
    save();
  } else {
    main_model = JSON.parse(stored_main_model);
  }
  setInterval(loop, 1000);
  // setTimeout(loop, 1000);
}

function save() {
  localStorage.setItem(MAIN_MODEL_KEY, JSON.stringify(main_model));
}

function add_product() {
  main_model.clicked_products++;
  main_model.products = main_model.clicked_products + loop_get_new_count();
  update_ui();
}

function add_worker(speed) {
  var new_worker = Object.assign({}, base_worker_model);
  new_worker.created_at = _get_seconds((new Date).getTime());
  new_worker.speed = speed;
  main_model.workers.push(new_worker);
  update_ui();
}

function loop() {
  main_model.products = main_model.clicked_products + loop_get_new_count();
  update_ui();
  save();
}

function update_ui() {
  document.querySelector('#products .count').innerHTML = main_model.products;
  document.querySelector('#workers .count').innerHTML = main_model.workers.length;
}

function loop_get_new_count() {
  var current_workers = main_model.workers;
  var current_time = _get_seconds((new Date).getTime());
  var current_products_count = 0;
  current_workers.forEach(function(worker){
    var current_seconds = current_time - worker.created_at;
    current_products_count += current_seconds * worker.speed;
  });
  return current_products_count;
}

// BEGIN: helpers

function _get_seconds(miliseconds) {
  return parseInt(Math.floor(miliseconds / 1000));
}

// END: helpers

</script>
</body>
</html>
